{% extends 'classes/base.html' %}

{% block title %}Libreta - {{ student.name }}{% endblock %}
{% block page_title %}üìí Libreta de Calificaciones{% endblock %}

{% block content %}
<style>
    .report-card-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .report-header {
        border: 3px solid #667eea;
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
    }
    
    .report-title {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .report-title h1 {
        color: #667eea;
        font-size: 2.5em;
        margin-bottom: 5px;
    }
    
    .student-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .info-item {
        display: flex;
        gap: 10px;
    }
    
    .info-item strong {
        color: #374151;
        min-width: 120px;
    }
    
    .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        margin: 30px 0 20px 0;
        font-size: 1.3em;
        font-weight: bold;
    }
    
    .grades-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }
    
    .grades-table th {
        background: #F3F4F6;
        padding: 15px;
        text-align: left;
        font-weight: bold;
        border-bottom: 2px solid #E5E7EB;
    }
    
    .grades-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #E5E7EB;
    }
    
    .grades-table tr:hover {
        background: #F9FAFB;
    }
    
    .grade-score {
        font-size: 1.3em;
        font-weight: bold;
        color: #667eea;
    }
    
    .grade-excellent { color: #10B981; }
    .grade-good { color: #F59E0B; }
    .grade-regular { color: #EF4444; }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }
    
    .summary-card {
        background: #F9FAFB;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border-left: 4px solid #667eea;
    }
    
    .summary-card h3 {
        font-size: 2.5em;
        color: #667eea;
        margin-bottom: 5px;
    }
    
    .summary-card p {
        color: #6B7280;
        font-size: 0.95em;
    }
    
    .attendance-mini-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-top: 20px;
    }
    
    .attendance-mini-item {
        padding: 10px;
        border-radius: 8px;
        text-align: center;
        font-size: 13px;
    }
    
    .attendance-presente { background: #D1FAE5; color: #065F46; }
    .attendance-ausente { background: #FEE2E2; color: #991B1B; }
    .attendance-tardanza { background: #FEF3C7; color: #92400E; }
    
    .actions-bar {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        padding-top: 30px;
        border-top: 2px solid #E5E7EB;
        flex-wrap: wrap;
    }
    
    @media print {
        .sidebar, .topbar, .actions-bar, .btn { display: none; }
        .report-card-container { box-shadow: none; padding: 20px; }
    }
</style>

<div class="report-card-container">
    <!-- HEADER DE LA LIBRETA -->
    <div class="report-header">
        <div class="report-title">
            <h1>üìí LIBRETA DE CALIFICACIONES</h1>
            <p style="font-size: 1.2em; color: #6B7280;">A√±o Escolar 2024-2025</p>
        </div>
        
        <div class="student-info-grid">
            <div class="info-item">
                <strong>{{ teacher.full_name }}</strong><br>
            <span style="color: #6B7280;">Docente de M√∫sica</span>
        </div>
    </div>
    
    <!-- BARRA DE ACCIONES -->
    <div class="actions-bar">
        <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Imprimir Libreta</button>
        <a href="{% url 'send_complete_report' student.id %}" class="btn btn-orange">üìß Enviar por Email</a>
        <a href="{% url 'student_detail' student.id %}" class="btn btn-view">‚Üê Volver al Estudiante</a>
    </div>
</div>
{% endblock %}
Estudiante:</strong>
                <span>{{ student.name }}</span>
            </div>
            <div class="info-item">
                <strong>A√±o:</strong>
                <span>{{ student.grade }}</span>
            </div>
            <div class="info-item">
                <strong>Docente:</strong>
                <span>{{ teacher.full_name }}</span>
            </div>
            <div class="info-item">
                <strong>Fecha:</strong>
                <span>{{ "now"|date:"d F Y" }}</span>
            </div>
            {% if student.parent_name %}
            <div class="info-item">
                <strong>Padre/Madre:</strong>
                <span>{{ student.parent_name }}</span>
            </div>
            {% endif %}
            {% if student.parent_phone %}
            <div class="info-item">
                <strong>Contacto:</strong>
                <span>{{ student.parent_phone }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- RESUMEN GENERAL -->
    <div class="section-header">üìä Resumen General</div>
    
    <div class="summary-grid">
        <div class="summary-card">
            <h3>{{ promedio_general|floatformat:2 }}</h3>
            <p>Promedio General</p>
        </div>
        <div class="summary-card">
            <h3>{{ total_classes }}</h3>
            <p>Clases Registradas</p>
        </div>
        <div class="summary-card">
            <h3>{{ attendance_percentage|floatformat:1 }}%</h3>
            <p>Asistencia</p>
        </div>
        <div class="summary-card">
            <h3>{{ grades_by_subject|length }}</h3>
            <p>Materias</p>
        </div>
    </div>
    
    <!-- CALIFICACIONES POR MATERIA -->
    <div class="section-header">üìö Calificaciones por Materia</div>
    
    {% for subject, subject_grades in grades_by_subject.items %}
    <h3 style="color: #374151; margin: 20px 0 10px 0;">
        {% if 'Guitarra' in subject %}üé∏{% elif 'Conjunto' in subject %}üé∫{% else %}üéµ{% endif %}
        {{ subject }}
    </h3>
    
    <table class="grades-table">
        <thead>
            <tr>
                <th>Per√≠odo</th>
                <th>Calificaci√≥n</th>
                <th>Fecha</th>
                <th>Comentarios</th>
            </tr>
        </thead>
        <tbody>
            {% for grade in subject_grades %}
            <tr>
                <td>{{ grade.period }}</td>
                <td>
                    <span class="grade-score {% if grade.score >= 9 %}grade-excellent{% elif grade.score >= 7 %}grade-good{% else %}grade-regular{% endif %}">
                        {{ grade.score }}
                    </span> / 10
                </td>
                <td>{{ grade.date|date:"d M Y" }}</td>
                <td>{{ grade.comments|default:"-" }}</td>
            </tr>
            {% endfor %}
            <tr style="background: #F9FAFB; font-weight: bold;">
                <td>PROMEDIO</td>
                <td colspan="3">
                    <span class="grade-score">
                        {{ subject_grades|length|default:0 }}
                        {% with sum=0 %}
                            {% for g in subject_grades %}
                                {% widthratio g.score 1 1 as score_val %}
                            {% endfor %}
                        {% endwith %}
                    </span>
                </td>
            </tr>
        </tbody>
    </table>
    {% empty %}
    <p style="color: #6B7280; padding: 20px; text-align: center;">No hay calificaciones registradas</p>
    {% endfor %}
    
    <!-- REGISTRO DE CLASES -->
    <div class="section-header">üìù Registro de Clases</div>
    
    {% for subject, subject_activities in activities_by_subject.items %}
    <h3 style="color: #374151; margin: 20px 0 10px 0;">
        {% if 'Guitarra' in subject %}üé∏{% elif 'Conjunto' in subject %}üé∫{% else %}üéµ{% endif %}
        {{ subject }} ({{ subject_activities|length }} clases)
    </h3>
    
    <table class="grades-table">
        <thead>
            <tr>
                <th>Clase #</th>
                <th>Fecha</th>
                <th>Temas</th>
                <th>Desempe√±o</th>
            </tr>
        </thead>
        <tbody>
            {% for activity in subject_activities %}
            <tr>
                <td><strong>#{{ activity.class_number }}</strong></td>
                <td>{{ activity.date|date:"d M Y" }}</td>
                <td>{{ activity.topics_worked|truncatewords:10|default:"-" }}</td>
                <td>
                    <span class="badge badge-{{ activity.performance|lower|slugify }}">
                        {{ activity.performance }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% empty %}
    <p style="color: #6B7280; padding: 20px; text-align: center;">No hay clases registradas</p>
    {% endfor %}
    
    <!-- REGISTRO DE ASISTENCIA -->
    <div class="section-header">‚úÖ Registro de Asistencia</div>
    
    <div class="summary-grid" style="margin-bottom: 20px;">
        <div class="summary-card">
            <h3>{{ presente_count }}</h3>
            <p>‚úÖ Presente</p>
        </div>
        <div class="summary-card">
            <h3>{{ ausente_count }}</h3>
            <p>‚ùå Ausente</p>
        </div>
        <div class="summary-card">
            <h3>{{ tardanza_count }}</h3>
            <p>‚è∞ Tardanza</p>
        </div>
        <div class="summary-card">
            <h3>{{ total_attendance }}</h3>
            <p>Total Registros</p>
        </div>
    </div>
    
    <div class="attendance-mini-list">
        {% for attendance in attendances %}
        <div class="attendance-mini-item attendance-{{ attendance.status|lower|slugify }}">
            <div>{{ attendance.date|date:"d/m" }}</div>
            <div style="font-weight: bold; font-size: 11px;">{{ attendance.status }}</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- OBSERVACIONES FINALES -->
    <div class="section-header">üí° Observaciones del Docente</div>
    
    <div style="background: #F9FAFB; padding: 20px; border-radius: 10px; min-height: 100px;">
        {% if student.notes %}
            <p>{{ student.notes }}</p>
        {% else %}
            <p style="color: #6B7280; font-style: italic;">Sin observaciones adicionales</p>
        {% endif %}
    </div>
    
    <!-- FIRMA -->
    <div style="margin-top: 50px; text-align: center;">
        <div style="display: inline-block; border-top: 2px solid #374151; padding-top: 10px; min-width: 300px;">
            <strong>